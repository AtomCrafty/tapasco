#!/usr/bin/python
import argparse
import sys
import subprocess
from   socket import gethostname
import os

tools        = ['tapasco-debug', 'tapasco-benchmark']
default_cmd  = 'mkdir -p {0} && cd {0} && cmake {1} .. && make -j install DESTDIR={0}/install'
tlkm_cmd     = 'cd {0} && make -j {1}'

parser = argparse.ArgumentParser()
parser.add_argument('--mode', help='build mode (default: %(default)s)', default='release', choices=['clean', 'release', 'debug', 'driver_debug'])
parser.add_argument('--rebuild', help='force rebuild libs (default: %(default)s)', action='store_true')
parser.add_argument('--shared', help='build shared library instead of static', action='store_true')
parser.add_argument('--package', help='build installation packages', action='store_true')
args = parser.parse_args()

clean        = args.mode == 'clean'
debug        = args.mode == 'debug' or args.mode == 'driver_debug'
driver_debug = args.mode == 'driver_debug'
debug_flags  = '-DCMAKE_BUILD_TYPE=Debug' if debug else '-DCMAKE_BUILD_TYPE=Release'

shared_flags = '-DBUILD_SHARED_LIBS:BOOL={}'.format('ON' if args.shared else 'OFF')

print 'Build mode: ' + args.mode

mdir = '%s/bin'			% os.environ['TAPASCO_HOME']
mdir = '%s/tlkm'		% os.environ['TAPASCO_HOME']
pdir = '%s/platform/build'	% os.environ['TAPASCO_HOME']
adir = '%s/arch/build'		% os.environ['TAPASCO_HOME']
tdir = '%s/arch/tests/build'	% os.environ['TAPASCO_HOME']
ldir = '%s/lib'			% os.environ['TAPASCO_HOME']
bdir   = os.environ['TAPASCO_HOME'] + '/build'

if clean or args.rebuild:
	subprocess.call(['rm -rf %s' % bdir], shell=True)
	subprocess.call(['cd %s && make clean' % mdir], shell=True)

if not clean:
	if debug:
		print('Building debug mode libraries...')
	else:
		print('Building release mode libraries...')

	if 'LINUX_HOME' in os.environ:
		subprocess.call(['make -C ' + os.environ['LINUX_HOME'] + ' scripts'], shell=True)

	subprocess.call([tlkm_cmd.format(mdir, '' if driver_debug else 'release')], shell=True)
	cmd = default_cmd.format(bdir, " ".join([debug_flags, shared_flags]))
	subprocess.call([cmd], shell=True)
	if args.package:
		subprocess.call("cd {0} && make -j package".format(bdir), shell=True)
